<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MR Hasar DanÄ±ÅŸmanlÄ±k - Ä°hbar FÃ¶yÃ¼</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2C5F8D 0%, #1a3d5c 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 5px;
        }
        
        .header p {
            font-size: 14px;
            color: #B8D4E8;
        }
        
        .tab-container {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
        }
        
        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            font-weight: bold;
            font-size: 15px;
            background: #f8f9fa;
            border: none;
            transition: all 0.3s;
        }
        
        .tab:hover {
            background: #e9ecef;
        }
        
        .tab.active {
            background: white;
            color: #2C5F8D;
            border-bottom: 3px solid #2C5F8D;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .form-content {
            padding: 30px 40px;
        }
        
        .section {
            margin-bottom: 20px;
            padding: 15px 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #2C5F8D;
        }
        
        .section-title {
            font-size: 13px;
            font-weight: bold;
            color: #2C5F8D;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 10px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group.full-width {
            grid-column: 1 / -1;
        }
        
        label {
            font-size: 11px;
            font-weight: 600;
            color: #495057;
            margin-bottom: 4px;
        }
        
        input[type="text"], input[type="date"], input[type="number"], textarea, select {
            padding: 8px 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 12px;
            transition: all 0.3s;
        }
        
        input[type="text"]:focus, input[type="date"]:focus, input[type="number"]:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #2C5F8D;
            box-shadow: 0 0 0 3px rgba(44, 95, 141, 0.1);
        }
        
        textarea {
            resize: vertical;
            min-height: 60px;
            font-family: inherit;
        }
        
        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 8px;
            margin-top: 10px;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .checkbox-item input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }
        
        .checkbox-item label {
            margin: 0;
            cursor: pointer;
            font-weight: normal;
            font-size: 11px;
        }
        
        /* PARÃ‡A LÄ°STESÄ° STYLES */
        .parts-input-section {
            background: #fff;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 30px;
            border: 2px solid #2C5F8D;
        }
        
        .parts-input-grid {
            display: grid;
            grid-template-columns: 2fr 1fr 1.2fr 1.2fr 0.8fr;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .parts-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .parts-table th {
            background: #2C5F8D;
            color: white;
            padding: 12px;
            text-align: left;
            font-size: 13px;
            font-weight: bold;
        }
        
        .parts-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #dee2e6;
            font-size: 13px;
        }
        
        .parts-table tr:hover {
            background: #f8f9fa;
        }
        
        .parts-table .actions {
            text-align: center;
        }
        
        .delete-btn {
            background: #DC3545;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }
        
        .delete-btn:hover {
            background: #c82333;
            transform: scale(1.05);
        }
        
        .total-section {
            background: #FFF3CD;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            border: 2px solid #FFC107;
        }
        
        .total-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-size: 16px;
            font-weight: bold;
        }
        
        .total-row.grand {
            font-size: 20px;
            color: #2C5F8D;
            padding-top: 10px;
            border-top: 2px solid #2C5F8D;
        }
        
        /* MODAL STYLES */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s;
        }
        
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 12px;
            width: 90%;
            max-width: 800px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            animation: slideDown 0.3s;
        }
        
        .modal-header {
            background: linear-gradient(135deg, #3498DB 0%, #2874A6 100%);
            color: white;
            padding: 20px;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h2 {
            margin: 0;
            font-size: 18px;
        }
        
        .close-modal {
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            background: none;
            border: none;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.3s;
        }
        
        .close-modal:hover {
            background: rgba(255,255,255,0.2);
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .search-box {
            position: relative;
            margin-bottom: 20px;
        }
        
        .search-box input {
            width: 100%;
            padding: 12px 40px 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .search-box input:focus {
            border-color: #3498DB;
            outline: none;
        }
        
        .search-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
            font-size: 18px;
        }
        
        .files-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
        }
        
        .file-item {
            padding: 15px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.3s;
        }
        
        .file-item:hover {
            background: #f8f9fa;
        }
        
        .file-item:last-child {
            border-bottom: none;
        }
        
        .file-info {
            flex: 1;
        }
        
        .file-title {
            font-weight: bold;
            color: #2C5F8D;
            font-size: 15px;
            margin-bottom: 5px;
        }
        
        .file-details {
            font-size: 12px;
            color: #666;
        }
        
        .file-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn-load {
            background: #3498DB;
            color: white;
        }
        
        .btn-load:hover {
            background: #2874A6;
        }
        
        .btn-delete {
            background: #E74C3C;
            color: white;
        }
        
        .btn-delete:hover {
            background: #C0392B;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideDown {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .button-container {
            padding: 30px 40px;
            background: #f8f9fa;
            display: flex;
            gap: 15px;
            justify-content: center;
            border-top: 1px solid #e0e0e0;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 15px 30px;
            font-size: 16px;
            font-weight: bold;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #28A745 0%, #20873a 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.6);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #DC3545 0%, #c82333 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(220, 53, 69, 0.4);
        }
        
        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(220, 53, 69, 0.6);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #FFC107 0%, #e0a800 100%);
            color: #000;
            box-shadow: 0 4px 15px rgba(255, 193, 7, 0.4);
        }
        
        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 193, 7, 0.6);
        }
        
        .btn-info {
            background: linear-gradient(135deg, #17A2B8 0%, #138496 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(23, 162, 184, 0.4);
        }
        
        .btn-info:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(23, 162, 184, 0.6);
        }
        
        .btn-small {
            padding: 10px 20px;
            font-size: 14px;
        }
        
        @media (max-width: 768px) {
            .form-row, .parts-input-grid {
                grid-template-columns: 1fr;
            }
            
            .checkbox-group {
                grid-template-columns: 1fr;
            }
        }
        
        /* YAZDIR / PDF Ä°Ã‡Ä°N STILLER */
        @media print {
            @page {
                size: A4;
                margin: 15mm;
            }
            
            body {
                background: white;
                padding: 0;
                margin: 0;
            }
            
            /* YAZDIRIRKEN GÄ°ZLE */
            .tab-container, 
            .button-container, 
            .parts-input-section,
            div[style*="background: #FFF3CD"],
            #quick-excel-btn,
            button[onclick*="excelImport"],
            #parca-tab .form-content > div:nth-child(2) {
                display: none !important;
            }
            
            .container {
                box-shadow: none;
                border-radius: 0;
                max-width: 100%;
                width: 100%;
            }
            
            .header {
                background: white !important;
                color: #2C5F8D !important;
                border-bottom: 3px solid #2C5F8D;
                padding: 15px;
                margin-bottom: 15px;
            }
            
            .header h1 {
                font-size: 18px;
                color: #2C5F8D;
            }
            
            .header p {
                font-size: 11px;
                color: #666;
            }
            
            .form-content {
                max-height: none !important;
                overflow: visible !important;
                padding: 0 !important;
            }
            
            .tab-content {
                display: block !important;
            }
            
            /* Ä°HBAR FÃ–YÃœ - Tek sayfaya sÄ±ÄŸdÄ±r */
            #dosya-tab .section {
                page-break-inside: avoid;
                margin-bottom: 12px;
                padding: 10px 12px;
                background: #f8f9fa !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            
            #dosya-tab .section-title {
                font-size: 11px;
                margin-bottom: 8px;
                color: #2C5F8D !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            
            #dosya-tab .form-row {
                margin-bottom: 6px;
            }
            
            #dosya-tab label {
                font-size: 9px;
                margin-bottom: 2px;
            }
            
            #dosya-tab input, #dosya-tab textarea, #dosya-tab select {
                font-size: 10px;
                padding: 4px 6px;
                border: 1px solid #ccc;
            }
            
            #dosya-tab textarea {
                min-height: 40px;
            }
            
            #dosya-tab .checkbox-group {
                gap: 4px;
                margin-top: 6px;
            }
            
            #dosya-tab .checkbox-item {
                gap: 4px;
            }
            
            #dosya-tab .checkbox-item label {
                font-size: 9px;
            }
            
            /* PARÃ‡A LÄ°STESÄ° */
            #parca-tab {
                page-break-before: always;
            }
            
            /* YazdÄ±rÄ±rken baÅŸlÄ±ÄŸÄ± gÃ¶ster */
            #print-parts-header {
                display: block !important;
            }
            
            .parts-table {
                page-break-inside: auto;
                width: 100%;
                font-size: 9px;
            }
            
            .parts-table th {
                background: #2C5F8D !important;
                color: white !important;
                padding: 6px 4px;
                font-size: 9px;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            
            .parts-table td {
                padding: 5px 4px;
                border-bottom: 1px solid #dee2e6;
                font-size: 9px;
            }
            
            .parts-table tr {
                page-break-inside: avoid;
            }
            
            .parts-table .actions {
                display: none;
            }
            
            .total-section {
                background: #FFF3CD !important;
                padding: 12px;
                border: 2px solid #FFC107;
                margin-top: 12px;
                page-break-inside: avoid;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            
            .total-row {
                font-size: 11px;
                margin-bottom: 6px;
            }
            
            .total-row.grand {
                font-size: 13px;
                padding-top: 8px;
                border-top: 2px solid #2C5F8D;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>MR HASAR DANIÅMANLIK VE FÄ°LO YÃ–NETÄ°MÄ°</h1>
            <p>Ä°hbar FÃ¶yÃ¼ ve ParÃ§a Listesi YÃ¶netim Sistemi</p>
        </div>
        
        <div class="tab-container">
            <button class="tab active" onclick="switchTab('dosya')">ğŸ“‹ Ä°hbar FÃ¶yÃ¼</button>
            <button class="tab" onclick="switchTab('parca')">ğŸ”§ ParÃ§a Listesi</button>
        </div>
        
        <!-- DOSYA BÄ°LGÄ°LERÄ° TAB -->
        <div id="dosya-tab" class="tab-content active">
            <div class="form-content">
                <!-- ARAÃ‡ VE SAHÄ°P BÄ°LGÄ°LERÄ° -->
                <div class="section">
                    <div class="section-title">ğŸš— ARAÃ‡ VE SAHÄ°P BÄ°LGÄ°LERÄ°</div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Plaka:</label>
                            <input type="text" id="plaka">
                        </div>
                        <div class="form-group">
                            <label>Marka / Model:</label>
                            <input type="text" id="marka">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Åasi No:</label>
                            <input type="text" id="sasi">
                        </div>
                        <div class="form-group">
                            <label>Kilometre:</label>
                            <input type="text" id="kilometre">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Ruhsat Sahibi Ad Soyad:</label>
                            <input type="text" id="sahip_ad">
                        </div>
                        <div class="form-group">
                            <label>TC Kimlik No / Telefon:</label>
                            <input type="text" id="sahip_tel">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group full-width">
                            <label>IBAN:</label>
                            <input type="text" id="iban">
                        </div>
                    </div>
                </div>
                
                <!-- DOSYA BÄ°LGÄ°LERÄ° -->
                <div class="section">
                    <div class="section-title">ğŸ“‹ DOSYA BÄ°LGÄ°LERÄ°</div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Sigorta Åirketi:</label>
                            <input type="text" id="sigorta">
                        </div>
                        <div class="form-group">
                            <label>Dosya No:</label>
                            <input type="text" id="dosya_no">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Dosya TÃ¼rÃ¼:</label>
                            <select id="dosya_turu">
                                <option value="KASKO">KASKO</option>
                                <option value="TRAFÄ°K">TRAFÄ°K</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>PoliÃ§e No:</label>
                            <input type="text" id="police_no">
                        </div>
                    </div>
                </div>
                
                <!-- EKSPER VE SERVÄ°S BÄ°LGÄ°LERÄ° -->
                <div class="section">
                    <div class="section-title">ğŸ” EKSPER VE SERVÄ°S BÄ°LGÄ°LERÄ°</div>
                    
                    <!-- EKSPER -->
                    <div class="form-row">
                        <div class="form-group">
                            <label>Eksper Ofisi & AdÄ±:</label>
                            <input type="text" id="eksper_adi">
                        </div>
                        <div class="form-group">
                            <label>Ä°letiÅŸim Bilgisi:</label>
                            <input type="text" id="eksper_iletisim" placeholder="Telefon / E-posta">
                        </div>
                    </div>
                    
                    <!-- Ä°NCE Ã‡Ä°ZGÄ° AYIRICI -->
                    <div style="border-top: 1px solid #dee2e6; margin: 20px 0;"></div>
                    
                    <!-- SERVÄ°S -->
                    <div class="form-row">
                        <div class="form-group">
                            <label>Servis AdÄ±:</label>
                            <input type="text" id="servis_adi">
                        </div>
                        <div class="form-group">
                            <label>Yetkili AdÄ± SoyadÄ±:</label>
                            <input type="text" id="servis_yetkili" placeholder="Yetkili kiÅŸi">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group full-width">
                            <label>Servis Ä°letiÅŸim ve Adres:</label>
                            <input type="text" id="servis_tel">
                        </div>
                    </div>
                </div>
                
                <!-- KAZA BÄ°LGÄ°LERÄ° -->
                <div class="section">
                    <div class="section-title">âš ï¸ KAZA BÄ°LGÄ°LERÄ°</div>
                    <div class="form-row">
                        <div class="form-group full-width">
                            <label>Kaza Yeri:</label>
                            <input type="text" id="kaza_yeri">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group full-width">
                            <label>Kaza AÃ§Ä±klamasÄ±:</label>
                            <textarea id="kaza_aciklama" rows="4"></textarea>
                        </div>
                    </div>
                </div>
                
                <!-- EVRAK KONTROL -->
                <div class="section">
                    <div class="section-title">âœ“ EVRAK KONTROL</div>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="evrak_ehliyet">
                            <label for="evrak_ehliyet">Ehliyet</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="evrak_ruhsat">
                            <label for="evrak_ruhsat">Ruhsat</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="evrak_police">
                            <label for="evrak_police">PoliÃ§e</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="evrak_ktt">
                            <label for="evrak_ktt">KTT</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="evrak_iban">
                            <label for="evrak_iban">IBAN</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="evrak_kilometre">
                            <label for="evrak_kilometre">Kilometre</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="evrak_olay">
                            <label for="evrak_olay">Olay Yeri Foto</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="evrak_hasar">
                            <label for="evrak_hasar">Hasar Foto</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="evrak_parca">
                            <label for="evrak_parca">ParÃ§a Listesi</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="evrak_ekspertiz">
                            <label for="evrak_ekspertiz">Ekspertiz Raporu</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="evrak_fatura">
                            <label for="evrak_fatura">OnarÄ±m FaturasÄ±</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="evrak_vekaletname">
                            <label for="evrak_vekaletname">Vekaletname</label>
                        </div>
                    </div>
                </div>
                
                <!-- Ä°ÅLEM DURUMU -->
                <div class="section">
                    <div class="section-title">âš¡ Ä°ÅLEM DURUMU</div>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="islem_ihbar">
                            <label for="islem_ihbar">Ä°hbar YapÄ±ldÄ±</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="islem_evrak">
                            <label for="islem_evrak">Evrak GÃ¶nderildi</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="islem_ekspertiz">
                            <label for="islem_ekspertiz">Ekspertiz YapÄ±ldÄ±</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="islem_basladi">
                            <label for="islem_basladi">OnarÄ±m BaÅŸladÄ±</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="islem_bitti">
                            <label for="islem_bitti">OnarÄ±m Bitti</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="islem_odeme">
                            <label for="islem_odeme">Ã–deme AlÄ±ndÄ±</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="islem_deger">
                            <label for="islem_deger">DeÄŸer KaybÄ± AÃ§Ä±ldÄ±</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="islem_kapandi">
                            <label for="islem_kapandi">Dosya KapatÄ±ldÄ±</label>
                        </div>
                    </div>
                </div>
                
                <!-- NOTLAR -->
                <div class="section">
                    <div class="section-title">ğŸ“ NOTLAR</div>
                    <div class="form-row">
                        <div class="form-group full-width">
                            <textarea id="notlar" rows="4"></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- PARÃ‡A LÄ°STESÄ° TAB -->
        <div id="parca-tab" class="tab-content">
            <div class="form-content">
                <!-- SADECE YAZDIRMADA GÃ–RÃœNEN BAÅLIK -->
                <div id="print-parts-header" style="display: none; text-align: center; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #2C5F8D;">
                    <h3 style="color: #2C5F8D; font-size: 16px; margin: 0;">HASAR PARÃ‡A LÄ°STESÄ°</h3>
                    <p id="print-plaka-info" style="color: #666; font-size: 12px; margin: 5px 0 0 0;"></p>
                </div>
                
                <!-- EXCEL Ä°Ã‡E AKTAR BÃ–LÃœMÃœ -->
                <div style="background: #FFF3CD; padding: 20px; border-radius: 12px; margin-bottom: 25px; border: 2px solid #FFC107;">
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                        <span style="font-weight: bold; font-size: 15px; color: #856404;">ğŸ“‚ EXCEL'DEN PARÃ‡A LÄ°STESÄ° YÃœKLEYÄ°N</span>
                    </div>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                        <input type="file" id="excelImport" accept=".xlsx,.xls" onchange="importFromExcel()" style="padding: 10px; border: 2px solid #FFC107; border-radius: 8px; background: white; flex: 1; min-width: 250px;">
                        <button class="btn btn-info btn-small" onclick="downloadTemplate()">ğŸ“„ Åablon Ä°ndir</button>
                    </div>
                    <div style="margin-top: 10px; font-size: 12px; color: #856404;">
                        â„¹ï¸ Servisin gÃ¶nderdiÄŸi Excel dosyasÄ±nÄ± seÃ§in - otomatik olarak tabloya eklenecek. Veya ÅŸablon indirip doldurun.
                    </div>
                </div>
                
                <!-- AI TARAMA BÃ–LÃœMÃœ -->
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 12px; margin-bottom: 25px; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);">
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                        <span style="font-weight: bold; font-size: 16px; color: white;">ğŸ¤– AI Ä°LE OTOMATIK TARAMA</span>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <!-- RUHSAT YÃœKLE -->
                        <div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 8px; border: 2px dashed rgba(255,255,255,0.3);">
                            <div style="color: white; font-weight: 600; margin-bottom: 10px; font-size: 14px;">ğŸ“¸ RUHSAT YÃœKLE</div>
                            <input type="file" id="ruhsatInput" accept="image/*,.pdf" style="display: none;" onchange="handleRuhsatUpload(event)">
                            <button onclick="document.getElementById('ruhsatInput').click()" style="width: 100%; padding: 12px; background: white; color: #667eea; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; transition: all 0.3s;">
                                ğŸ“¸ Ruhsat SeÃ§
                            </button>
                            <div style="color: rgba(255,255,255,0.8); font-size: 11px; margin-top: 8px; line-height: 1.4;">
                                AraÃ§ ruhsatÄ±nÄ± yÃ¼kleyin<br>Marka, model, plaka otomatik doldurulur
                            </div>
                        </div>
                        
                        <!-- PARÃ‡A LÄ°STESÄ° YÃœKLE -->
                        <div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 8px; border: 2px dashed rgba(255,255,255,0.3);">
                            <div style="color: white; font-weight: 600; margin-bottom: 10px; font-size: 14px;">ğŸ“‹ PARÃ‡A LÄ°STESÄ° YÃœKLE</div>
                            <input type="file" id="parcaListesiInput" accept="image/*,.pdf" style="display: none;" onchange="handleParcaListesiUpload(event)">
                            <button onclick="document.getElementById('parcaListesiInput').click()" style="width: 100%; padding: 12px; background: white; color: #764ba2; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; transition: all 0.3s;">
                                ğŸ“‹ ParÃ§a Listesi SeÃ§
                            </button>
                            <div style="color: rgba(255,255,255,0.8); font-size: 11px; margin-top: 8px; line-height: 1.4;">
                                El yazÄ±sÄ±/fotoÄŸraf/PDF<br>ParÃ§alar otomatik tanÄ±nÄ±r ve fiyatlandÄ±rÄ±lÄ±r
                            </div>
                        </div>
                    </div>
                    <div style="margin-top: 15px; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 6px; color: white; font-size: 12px;">
                        âš¡ PC'de Chrome ile kullanÄ±n! Mobil tarayÄ±cÄ±da sorun olabilir.
                    </div>
                </div>
                
                <div class="parts-input-section">
                    <div class="section-title">â• YENÄ° PARÃ‡A EKLE</div>
                    <div class="parts-input-grid">
                        <div class="form-group">
                            <label>ParÃ§a AdÄ±:</label>
                            <input type="text" id="part_name" placeholder="Ã–rn: Ã–n Far Komple LED">
                        </div>
                        <div class="form-group">
                            <label>OEM Kod:</label>
                            <input type="text" id="part_oem" placeholder="OEM Kodu">
                        </div>
                        <div class="form-group">
                            <label>Orijinal Fiyat (TL):</label>
                            <input type="number" id="part_original" placeholder="0">
                        </div>
                        <div class="form-group">
                            <label>Miktar:</label>
                            <input type="number" id="part_quantity" value="1" min="1">
                        </div>
                    </div>
                    <button class="btn btn-primary btn-small" onclick="addPart()">â• ParÃ§a Ekle</button>
                </div>
                
                <!-- KDV CHECKBOX -->
                <div style="background: #E8F5E9; padding: 15px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #27AE60;">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; font-size: 14px; font-weight: 600;">
                        <input type="checkbox" id="kdvCheckbox" onchange="renderPartsTable()" style="width: 20px; height: 20px;">
                        <span>ğŸ’µ KDV (%20) DAHÄ°L HESAPLA</span>
                    </label>
                    <p style="font-size: 11px; color: #666; margin: 8px 0 0 30px;">
                        â„¹ï¸ Fatura isteyen mÃ¼ÅŸteriler iÃ§in KDV dahil hesaplama yapÄ±lÄ±r
                    </p>
                </div>
                
                <!-- Ä°ÅÃ‡Ä°LÄ°K BEDELÄ° -->
                <div style="background: #FFF3CD; padding: 15px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #FFC107;">
                    <div style="font-weight: bold; font-size: 14px; color: #856404; margin-bottom: 10px;">
                        ğŸ”§ Ä°ÅÃ‡Ä°LÄ°K BEDELÄ°
                    </div>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="number" id="iscilikBedeli" placeholder="Ä°ÅŸÃ§ilik Bedeli (TL)" step="0.01" min="0" value="0" style="flex: 1; padding: 10px; border: 2px solid #FFC107; border-radius: 6px; font-size: 14px;" onchange="renderPartsTable()">
                        <span style="font-size: 12px; color: #856404; white-space: nowrap;">
                            âš ï¸ Ä°ÅŸÃ§iliÄŸe KDV eklenmez
                        </span>
                    </div>
                </div>
                
                <div class="section">
                    <div class="section-title">ğŸ“‹ PARÃ‡A LÄ°STESÄ°</div>
                    <table class="parts-table" id="partsTable">
                        <thead>
                            <tr>
                                <th style="width: 50px;">SÄ±ra</th>
                                <th style="width: 250px;">ParÃ§a AdÄ±</th>
                                <th style="width: 120px;">OEM Kod</th>
                                <th style="width: 100px; text-align: right;">Orijinal<br>(TL)</th>
                                <th style="width: 80px; text-align: right;">KDV<br>%20</th>
                                <th style="width: 100px; text-align: right;">KDV Dahil<br>(TL)</th>
                                <th style="width: 60px;">Miktar</th>
                                <th style="width: 80px;">Ä°ÅŸlem</th>
                            </tr>
                        </thead>
                                <th>Miktar</th>
                                <th>Ä°ÅŸlem</th>
                            </tr>
                        </thead>
                        <tbody id="partsTableBody">
                            <tr>
                                <td colspan="8" style="text-align: center; color: #999;">
                                    HenÃ¼z parÃ§a eklenmedi. YukarÄ±daki formu doldurup "ParÃ§a Ekle" butonuna tÄ±klayÄ±n.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    
                    <div class="total-section" id="totalSection" style="display: none;">
                        <div class="total-row">
                            <span>TOPLAM PARÃ‡A (KDV HariÃ§):</span>
                            <span id="totalParca">0 TL</span>
                        </div>
                        <div class="total-row" id="kdvRow" style="display: none;">
                            <span>TOPLAM KDV (%20):</span>
                            <span id="totalKDV">0 TL</span>
                        </div>
                        <div class="total-row" id="parcaKDVRow" style="display: none;">
                            <span>PARÃ‡A TOPLAMI (KDV Dahil):</span>
                            <span id="totalParcaKDV">0 TL</span>
                        </div>
                        <div class="total-row" id="iscilikRow" style="display: none;">
                            <span>Ä°ÅÃ‡Ä°LÄ°K (KDV yok):</span>
                            <span id="totalIscilik">0 TL</span>
                        </div>
                        <div class="total-row grand">
                            <span>GENEL TOPLAM:</span>
                            <span id="genelToplam">0 TL</span>
                        </div>
                    </div>
                    
                    <!-- HIZLI EXCEL YÃœKLEME BUTONU -->
                    <div id="quick-excel-btn" style="margin-top: 20px; text-align: center;">
                        <button class="btn btn-warning" onclick="document.getElementById('excelImport').click()" style="padding: 12px 24px; font-size: 14px;">
                            ğŸ“¥ EXCEL'DEN PARÃ‡A YÃœKLE
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="button-container">
            <button class="btn btn-success" onclick="saveFile()" style="background: linear-gradient(135deg, #27AE60 0%, #229954 100%);">
                ğŸ’¾ DOSYAYI KAYDET
            </button>
            <button class="btn btn-info" onclick="openSearchModal()" style="background: linear-gradient(135deg, #3498DB 0%, #2874A6 100%);">
                ğŸ” DOSYA ARA
            </button>
            <button class="btn btn-primary" onclick="createCompleteExcel()">
                ğŸ“Š KOMPLE EXCEL Ã‡IKTISI AL
            </button>
            <button class="btn btn-info" onclick="createPartsOnlyExcel()">
                ğŸ”§ SADECE PARÃ‡A LÄ°STESÄ° Ã‡IKTISI
            </button>
            <button class="btn btn-warning" onclick="printForm()" style="background: linear-gradient(135deg, #E74C3C 0%, #c0392b 100%);">
                ğŸ–¨ï¸ YAZDIR / PDF KAYDET
            </button>
            <button class="btn btn-secondary" onclick="clearAll()">
                ğŸ—‘ï¸ HEPSÄ°NÄ° TEMÄ°ZLE
            </button>
        </div>
    </div>
    
    <!-- DOSYA ARAMA MODAL -->
    <div id="searchModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ğŸ” KAYITLI DOSYALARI ARA</h2>
                <button class="close-modal" onclick="closeSearchModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="Plaka veya ad soyad ile arayÄ±n..." oninput="filterFiles()">
                    <span class="search-icon">ğŸ”</span>
                </div>
                <div class="files-list" id="filesList">
                    <div class="empty-state">
                        <p>ğŸ“ HenÃ¼z kaydedilmiÅŸ dosya yok</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- PARÃ‡A Ã–NÄ°ZLEME MODAL -->
    <div id="previewModal" class="modal">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <h2>ğŸ‘ï¸ PARÃ‡A LÄ°STESÄ° Ã–NÄ°ZLEME</h2>
                <button class="close-modal" onclick="closePreviewModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="previewMessage" style="padding: 15px; background: #E8F5E9; border-left: 4px solid #27AE60; border-radius: 6px; margin-bottom: 20px;">
                    <strong>âœ… AI Analizi TamamlandÄ±!</strong>
                    <p style="margin: 5px 0 0 0; font-size: 13px;">AÅŸaÄŸÄ±daki parÃ§alar tespit edildi. Kontrol edip onaylayÄ±n.</p>
                </div>
                <div id="previewContent" style="max-height: 400px; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 8px;">
                    <!-- Ã–nizleme tablosu buraya gelecek -->
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px; justify-content: flex-end;">
                    <button onclick="closePreviewModal()" style="padding: 12px 24px; background: #95a5a6; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                        âŒ Ä°ptal
                    </button>
                    <button onclick="confirmParcaListesi()" style="padding: 12px 24px; background: linear-gradient(135deg, #27AE60 0%, #229954 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                        âœ… ONAYLA VE EKLE
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let partsList = [];
        
        // Sayfa yÃ¼klendiÄŸinde
        document.addEventListener('DOMContentLoaded', function() {
            loadPartsFromStorage();
        });
        
        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            if (tab === 'dosya') {
                document.querySelector('.tab:nth-child(1)').classList.add('active');
                document.getElementById('dosya-tab').classList.add('active');
            } else {
                document.querySelector('.tab:nth-child(2)').classList.add('active');
                document.getElementById('parca-tab').classList.add('active');
            }
        }
        
        function addPart() {
            const name = document.getElementById('part_name').value.trim();
            const oem = document.getElementById('part_oem').value.trim();
            const original = parseFloat(document.getElementById('part_original').value) || 0;
            const quantity = parseInt(document.getElementById('part_quantity').value) || 1;
            
            if (!name) {
                alert('âš ï¸ LÃ¼tfen parÃ§a adÄ±nÄ± girin!');
                return;
            }
            
            if (original <= 0) {
                alert('âš ï¸ LÃ¼tfen geÃ§erli bir fiyat girin!');
                return;
            }
            
            const part = {
                name: name,
                oem: oem,
                original: original,
                quantity: quantity
            };
            
            partsList.push(part);
            savePartsToStorage();
            renderPartsTable();
            clearPartInputs();
        }
        
        function clearPartInputs() {
            document.getElementById('part_name').value = '';
            document.getElementById('part_oem').value = '';
            document.getElementById('part_original').value = '';
            document.getElementById('part_quantity').value = '1';
        }
        
        function deletePart(index) {
            if (confirm('Bu parÃ§ayÄ± silmek istediÄŸinize emin misiniz?')) {
                partsList.splice(index, 1);
                savePartsToStorage();
                renderPartsTable();
            }
        }
        
        function renderPartsTable() {
            const tbody = document.getElementById('partsTableBody');
            const totalSection = document.getElementById('totalSection');
            const kdvChecked = document.getElementById('kdvCheckbox').checked;
            const iscilik = parseFloat(document.getElementById('iscilikBedeli').value) || 0;
            
            if (partsList.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #999;">HenÃ¼z parÃ§a eklenmedi.</td></tr>';
                totalSection.style.display = 'none';
                return;
            }
            
            let html = '';
            let totalParca = 0;  // KDV'siz toplam
            
            partsList.forEach((part, index) => {
                const birimFiyat = part.original;
                const kdvTutari = birimFiyat * 0.20;
                const kdvDahil = birimFiyat + kdvTutari;
                const satirToplam = birimFiyat * part.quantity;
                
                totalParca += satirToplam;
                
                html += `
                    <tr>
                        <td style="text-align: center;">${index + 1}</td>
                        <td>${part.name}</td>
                        <td style="text-align: center;">${part.oem || '-'}</td>
                        <td style="text-align: right; font-weight: 600;">${birimFiyat.toLocaleString('tr-TR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                        <td style="text-align: right; color: #E67E22;">${kdvTutari.toLocaleString('tr-TR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                        <td style="text-align: right; font-weight: 600; color: #27AE60;">${kdvDahil.toLocaleString('tr-TR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                        <td style="text-align: center;">${part.quantity}</td>
                        <td class="actions" style="text-align: center;">
                            <button class="delete-btn" onclick="deletePart(${index})" style="padding: 4px 8px; font-size: 11px;">ğŸ—‘ï¸</button>
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
            
            // ToplamlarÄ± hesapla
            const totalKDV = totalParca * 0.20;
            const totalParcaKDV = totalParca + totalKDV;
            const genelToplam = (kdvChecked ? totalParcaKDV : totalParca) + iscilik;
            
            // ToplamlarÄ± gÃ¶ster
            document.getElementById('totalParca').textContent = totalParca.toLocaleString('tr-TR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' TL';
            document.getElementById('totalKDV').textContent = totalKDV.toLocaleString('tr-TR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' TL';
            document.getElementById('totalParcaKDV').textContent = totalParcaKDV.toLocaleString('tr-TR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' TL';
            document.getElementById('totalIscilik').textContent = iscilik.toLocaleString('tr-TR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' TL';
            document.getElementById('genelToplam').textContent = genelToplam.toLocaleString('tr-TR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' TL';
            
            // KDV satÄ±rlarÄ±nÄ± gÃ¶ster/gizle
            if (kdvChecked) {
                document.getElementById('kdvRow').style.display = 'flex';
                document.getElementById('parcaKDVRow').style.display = 'flex';
            } else {
                document.getElementById('kdvRow').style.display = 'none';
                document.getElementById('parcaKDVRow').style.display = 'none';
            }
            
            // Ä°ÅŸÃ§ilik satÄ±rÄ±nÄ± gÃ¶ster/gizle
            if (iscilik > 0) {
                document.getElementById('iscilikRow').style.display = 'flex';
            } else {
                document.getElementById('iscilikRow').style.display = 'none';
            }
            
            totalSection.style.display = 'block';
        }
        
        function savePartsToStorage() {
            localStorage.setItem('hasarParcaListesi', JSON.stringify(partsList));
        }
        
        function loadPartsFromStorage() {
            const stored = localStorage.getItem('hasarParcaListesi');
            if (stored) {
                partsList = JSON.parse(stored);
                renderPartsTable();
            }
        }
        
        function loadDefaultParts() {
            if (partsList.length > 0) {
                if (!confirm('Mevcut parÃ§a listesi silinecek ve varsayÄ±lan Kawasaki Z900 parÃ§alarÄ± yÃ¼klenecek. Devam edilsin mi?')) {
                    return;
                }
            }
            
            partsList = [
                {name: 'Ã–n Far Komple LED', oem: '', original: 22000, muadil: '11500', quantity: 1},
                {name: 'Far TaÅŸÄ±yÄ±cÄ± Braketi', oem: '', original: 3000, muadil: '1500', quantity: 1},
                {name: 'Ã–n Maske Alt PlastiÄŸi', oem: '', original: 3800, muadil: '1800', quantity: 1},
                {name: 'Ã–n Ã‡amurluk', oem: '', original: 5200, muadil: '2500', quantity: 1},
                {name: 'YakÄ±t Deposu', oem: '', original: 30000, muadil: '-', quantity: 1},
                {name: 'Depo Yan Kapak SaÄŸ', oem: '', original: 4200, muadil: '2100', quantity: 1},
                {name: 'Depo Yan Kapak Sol', oem: '', original: 4200, muadil: '2100', quantity: 1},
                {name: 'RadyatÃ¶r', oem: '', original: 18500, muadil: '10000', quantity: 1},
                {name: 'RadyatÃ¶r Yan Hava KanalÄ±', oem: '', original: 2500, muadil: '1200', quantity: 1},
                {name: 'Motor Alt Koruma PlastiÄŸi', oem: '', original: 3000, muadil: '1500', quantity: 1},
                {name: 'Motor SaÄŸ Kapak', oem: '', original: 5000, muadil: '-', quantity: 1},
                {name: 'Ã–n Sinyal SaÄŸ', oem: '', original: 2000, muadil: '800', quantity: 1},
                {name: 'Ã–n Sinyal Sol', oem: '', original: 2000, muadil: '800', quantity: 1},
                {name: 'Ayna SaÄŸ', oem: '', original: 3000, muadil: '1000', quantity: 1},
                {name: 'Ayna Sol', oem: '', original: 3000, muadil: '1000', quantity: 1}
            ];
            
            savePartsToStorage();
            renderPartsTable();
            alert('VarsayÄ±lan Kawasaki Z900 parÃ§alarÄ± yÃ¼klendi!');
        }
        
        function downloadTemplate() {
            const wb = XLSX.utils.book_new();
            
            const ws_data = [
                ['PARÃ‡A LÄ°STESÄ° ÅABLONU - MR HASAR DANIÅMANLIK'],
                ['Bu ÅŸablonu doldurup sisteme yÃ¼kleyebilirsiniz'],
                [],
                ['ParÃ§a AdÄ±', 'OEM Kodu', 'Orijinal Fiyat (TL)', 'Miktar'],
                ['Ã–n Far Komple LED', '12345-ABC', 22000, 1],
                ['Far TaÅŸÄ±yÄ±cÄ± Braketi', '67890-DEF', 3000, 1],
                ['Ã–n Ã‡amurluk', '', 5200, 1],
                [],
                ['NOTLAR:'],
                ['- ParÃ§a AdÄ±: Zorunlu alan'],
                ['- OEM Kodu: Opsiyonel (boÅŸ bÄ±rakÄ±labilir)'],
                ['- Orijinal Fiyat: Zorunlu (sayÄ± olarak, KDV hariÃ§ fiyat)'],
                ['- Miktar: VarsayÄ±lan 1, deÄŸiÅŸtirilebilir'],
                [''],
                ['KDV (%20) otomatik hesaplanacaktÄ±r.'],
                ['Ä°lk 4 satÄ±rÄ± silmeyin! ParÃ§alarÄ± 5. satÄ±rdan itibaren yazÄ±n.']
            ];
            
            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            
            // Kolon geniÅŸlikleri
            ws['!cols'] = [
                {wch: 35}, // ParÃ§a AdÄ±
                {wch: 15}, // OEM Kodu
                {wch: 18}, // Orijinal Fiyat
                {wch: 10}  // Miktar
            ];
            
            XLSX.utils.book_append_sheet(wb, ws, 'ParÃ§a Listesi');
            XLSX.writeFile(wb, 'Parca_Listesi_Sablonu.xlsx');
            
            alert('ğŸ“„ Åablon indirildi! Doldurup yÃ¼kleyebilirsiniz.');
        }
        
        function importFromExcel() {
            const fileInput = document.getElementById('excelImport');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('âš ï¸ LÃ¼tfen Ã¶nce bir Excel dosyasÄ± seÃ§in!');
                return;
            }
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    
                    // Ä°lk sheet'i al
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, {header: 1});
                    
                    // BaÅŸlÄ±k satÄ±rÄ±nÄ± bul (ParÃ§a AdÄ± iÃ§eren satÄ±r)
                    let headerRowIndex = -1;
                    for (let i = 0; i < jsonData.length; i++) {
                        if (jsonData[i] && jsonData[i][0] && 
                            (jsonData[i][0].toString().toLowerCase().includes('parÃ§a') || 
                             jsonData[i][0].toString().toLowerCase().includes('parca'))) {
                            headerRowIndex = i;
                            break;
                        }
                    }
                    
                    if (headerRowIndex === -1) {
                        alert('âš ï¸ Excel dosyasÄ±nda "ParÃ§a AdÄ±" baÅŸlÄ±k satÄ±rÄ± bulunamadÄ±!');
                        return;
                    }
                    
                    // BaÅŸlÄ±ktan sonraki satÄ±rlarÄ± oku
                    let importedParts = [];
                    let errorCount = 0;
                    let startRow = headerRowIndex + 1;
                    
                    // Bir sonraki satÄ±r da baÅŸlÄ±k mÄ± kontrol et (Ã§ift baÅŸlÄ±k durumu)
                    if (startRow < jsonData.length && jsonData[startRow] && jsonData[startRow][0]) {
                        const nextRowFirst = jsonData[startRow][0].toString().toLowerCase();
                        if (nextRowFirst.includes('parÃ§a') || nextRowFirst.includes('parca') || 
                            nextRowFirst.includes('oem') || nextRowFirst.includes('kod')) {
                            startRow++; // Bir satÄ±r daha atla
                        }
                    }
                    
                    for (let i = startRow; i < jsonData.length; i++) {
                        const row = jsonData[i];
                        
                        // BoÅŸ satÄ±rlarÄ± atla
                        if (!row || !row[0] || row[0].toString().trim() === '') continue;
                        
                        // NOT veya aÃ§Ä±klama satÄ±rlarÄ±nÄ± atla
                        const firstCell = row[0].toString().toUpperCase();
                        if (firstCell.includes('NOT') || firstCell.includes('TOPLAM') || 
                            firstCell.includes('âœ…') || firstCell.includes('ğŸ”¢') || firstCell.includes('KDV')) continue;
                        
                        try {
                            const partName = row[0] ? row[0].toString().trim() : '';
                            const oem = row[1] ? row[1].toString().trim() : '';
                            const original = parseFloat(row[2]) || 0;
                            
                            // Miktar kontrolÃ¼ - 4. sÃ¼tundan oku (artÄ±k muadil yok)
                            let quantity = 1;
                            if (row[3] !== undefined && row[3] !== null && row[3] !== '') {
                                const qty = parseInt(row[3]);
                                if (!isNaN(qty) && qty > 0) {
                                    quantity = qty;
                                }
                            }
                            
                            if (partName && original > 0) {
                                importedParts.push({
                                    name: partName,
                                    oem: oem,
                                    original: original,
                                    quantity: quantity
                                });
                            }
                        } catch (err) {
                            errorCount++;
                            console.log('SatÄ±r atlandi:', row, err);
                        }
                    }
                    
                    if (importedParts.length === 0) {
                        alert('âš ï¸ Excel dosyasÄ±nda geÃ§erli parÃ§a bulunamadÄ±!');
                        return;
                    }
                    
                    // Mevcut listeyi temizle ve yeni parÃ§alarÄ± ekle
                    if (partsList.length > 0) {
                        if (!confirm(`Mevcut ${partsList.length} parÃ§a silinecek ve ${importedParts.length} yeni parÃ§a eklenecek. Devam edilsin mi?`)) {
                            return;
                        }
                    }
                    
                    partsList = importedParts;
                    savePartsToStorage();
                    renderPartsTable();
                    
                    console.log('âœ… Ä°Ã§e aktarÄ±lan parÃ§alar:', partsList);
                    
                    // File input'u temizle
                    fileInput.value = '';
                    
                    let message = `âœ… BaÅŸarÄ±yla ${importedParts.length} parÃ§a iÃ§e aktarÄ±ldÄ±!`;
                    if (errorCount > 0) {
                        message += `\nâš ï¸ ${errorCount} satÄ±r atlandÄ±.`;
                    }
                    message += '\n\nParÃ§a listesi sekmesine geÃ§iliyor...';
                    alert(message);
                    
                    // ParÃ§a listesi sekmesine geÃ§
                    setTimeout(() => {
                        switchTab('parca');
                    }, 100);
                    
                } catch (error) {
                    console.error('Excel okuma hatasÄ±:', error);
                    alert('âŒ Excel dosyasÄ± okunurken hata oluÅŸtu! LÃ¼tfen dosya formatÄ±nÄ± kontrol edin.');
                }
            };
            
            reader.readAsArrayBuffer(file);
        }
        
        function getValue(id) {
            const el = document.getElementById(id);
            return el ? el.value : '';
        }
        
        function setValue(id, value) {
            const el = document.getElementById(id);
            if (el && value !== null && value !== undefined) {
                el.value = String(value).trim();
            }
        }
        
        function printForm() {
            // Plaka bilgisini yazdÄ±rma baÅŸlÄ±ÄŸÄ±na ekle
            const plaka = getValue('plaka') || 'Bilinmiyor';
            const marka = getValue('marka') || '';
            
            let plakaInfo = `Plaka: ${plaka}`;
            if (marka) {
                plakaInfo += ` | AraÃ§: ${marka}`;
            }
            
            document.getElementById('print-plaka-info').textContent = plakaInfo;
            
            // Her iki sekmeyi de gÃ¶rÃ¼nÃ¼r yap
            document.getElementById('dosya-tab').classList.add('active');
            document.getElementById('parca-tab').classList.add('active');
            
            // YazdÄ±r
            window.print();
            
            // YazdÄ±rma sonrasÄ± sadece aktif sekmeyi gÃ¶ster
            setTimeout(() => {
                const activeTab = document.querySelector('.tab.active');
                if (activeTab && activeTab.textContent.includes('Ä°hbar')) {
                    document.getElementById('parca-tab').classList.remove('active');
                } else if (activeTab && activeTab.textContent.includes('ParÃ§a')) {
                    document.getElementById('dosya-tab').classList.remove('active');
                }
            }, 1000);
        }
        
        function clearAll() {
            if (confirm('TÃœM FORM VE PARÃ‡A LÄ°STESÄ°NÄ° temizlemek istediÄŸinize emin misiniz?')) {
                // TÃ¼m form alanlarÄ±nÄ± temizle
                document.querySelectorAll('input[type="text"], input[type="date"], textarea, select').forEach(el => {
                    if (el.type === 'text' || el.type === 'date' || el.tagName === 'TEXTAREA') {
                        el.value = '';
                    }
                });
                
                // Select'leri sÄ±fÄ±rla
                document.getElementById('dosya_turu').value = 'KASKO';
                
                // Checkbox'larÄ± temizle
                document.querySelectorAll('input[type="checkbox"]').forEach(el => {
                    el.checked = false;
                });
                
                // ParÃ§a listesini temizle
                partsList = [];
                savePartsToStorage();
                renderPartsTable();
                
                alert('TÃ¼m form ve parÃ§a listesi temizlendi!');
            }
        }
        
        // DOSYA KAYDETME VE ARAMA FONKSÄ°YONLARI
        function saveFile() {
            const plaka = getValue('plaka').trim();
            const sahipAd = getValue('sahip_ad').trim();
            
            if (!plaka) {
                alert('âš ï¸ Plaka bilgisi zorunludur!');
                return;
            }
            
            if (!sahipAd) {
                alert('âš ï¸ AraÃ§ sahibi adÄ± zorunludur!');
                return;
            }
            
            // Form verilerini topla
            const formData = {
                // AraÃ§ ve sahip bilgileri
                plaka: plaka,
                marka: getValue('marka'),
                sasi: getValue('sasi'),
                kilometre: getValue('kilometre'),
                sahip_ad: sahipAd,
                sahip_tel: getValue('sahip_tel'),
                iban: getValue('iban'),
                
                // Dosya bilgileri
                sigorta: getValue('sigorta'),
                dosya_no: getValue('dosya_no'),
                dosya_turu: getValue('dosya_turu'),
                police_no: getValue('police_no'),
                
                // Eksper ve servis
                eksper_adi: getValue('eksper_adi'),
                eksper_iletisim: getValue('eksper_iletisim'),
                servis_adi: getValue('servis_adi'),
                servis_yetkili: getValue('servis_yetkili'),
                servis_tel: getValue('servis_tel'),
                
                // Kaza bilgileri
                kaza_tarihi: getValue('kaza_tarihi'),
                kaza_yeri: getValue('kaza_yeri'),
                kaza_aciklama: getValue('kaza_aciklama'),
                
                // Evrak ve iÅŸlem durumu
                evrak: getCheckedItems('evrak'),
                islem: getCheckedItems('islem'),
                
                // Notlar
                notlar: getValue('notlar')
            };
            
            // Dosya objesi oluÅŸtur
            const fileObj = {
                id: Date.now().toString(),
                plaka: plaka,
                sahipAd: sahipAd,
                kayitTarihi: new Date().toLocaleString('tr-TR'),
                formData: formData,
                parcaListesi: JSON.parse(JSON.stringify(partsList))
            };
            
            // LocalStorage'dan mevcut dosyalarÄ± al
            let files = [];
            try {
                const savedFiles = localStorage.getItem('hasar_dosyalar');
                if (savedFiles) {
                    files = JSON.parse(savedFiles);
                }
            } catch (e) {
                console.error('Dosyalar yÃ¼klenemedi:', e);
            }
            
            // AynÄ± plaka varsa Ã¼zerine yaz, yoksa ekle
            const existingIndex = files.findIndex(f => f.plaka === plaka);
            if (existingIndex !== -1) {
                if (confirm(`${plaka} plakalÄ± dosya zaten kayÄ±tlÄ±. Ãœzerine yazmak istiyor musunuz?`)) {
                    files[existingIndex] = fileObj;
                } else {
                    return;
                }
            } else {
                files.push(fileObj);
            }
            
            // LocalStorage'a kaydet
            try {
                localStorage.setItem('hasar_dosyalar', JSON.stringify(files));
                alert(`âœ… Dosya kaydedildi!\n\n${sahipAd} - ${plaka}`);
            } catch (e) {
                alert('âŒ Dosya kaydedilemedi! LocalStorage dolu olabilir.');
                console.error('KayÄ±t hatasÄ±:', e);
            }
        }
        
        function openSearchModal() {
            document.getElementById('searchModal').style.display = 'block';
            document.getElementById('searchInput').value = '';
            renderFilesList();
        }
        
        function closeSearchModal() {
            document.getElementById('searchModal').style.display = 'none';
        }
        
        function filterFiles() {
            renderFilesList();
        }
        
        function renderFilesList() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
            const filesList = document.getElementById('filesList');
            
            // LocalStorage'dan dosyalarÄ± al
            let files = [];
            try {
                const savedFiles = localStorage.getItem('hasar_dosyalar');
                if (savedFiles) {
                    files = JSON.parse(savedFiles);
                }
            } catch (e) {
                console.error('Dosyalar yÃ¼klenemedi:', e);
            }
            
            // Arama filtresi uygula
            if (searchTerm) {
                files = files.filter(f => 
                    f.plaka.toLowerCase().includes(searchTerm) || 
                    f.sahipAd.toLowerCase().includes(searchTerm)
                );
            }
            
            // Tarihe gÃ¶re sÄ±rala (en yeni Ã¼stte)
            files.sort((a, b) => parseInt(b.id) - parseInt(a.id));
            
            // Liste boÅŸsa
            if (files.length === 0) {
                filesList.innerHTML = `
                    <div class="empty-state">
                        <p>ğŸ“ ${searchTerm ? 'EÅŸleÅŸen dosya bulunamadÄ±' : 'HenÃ¼z kaydedilmiÅŸ dosya yok'}</p>
                    </div>
                `;
                return;
            }
            
            // DosyalarÄ± listele
            let html = '';
            files.forEach(file => {
                const parcaSayisi = file.parcaListesi ? file.parcaListesi.length : 0;
                html += `
                    <div class="file-item">
                        <div class="file-info">
                            <div class="file-title">${file.sahipAd} - ${file.plaka}</div>
                            <div class="file-details">
                                ğŸ“… ${file.kayitTarihi} | 
                                ğŸ”§ ${parcaSayisi} parÃ§a | 
                                ğŸ“‹ ${file.formData.dosya_turu}
                            </div>
                        </div>
                        <div class="file-actions">
                            <button class="btn-small btn-load" onclick="loadFile('${file.id}')">
                                ğŸ“‚ YÃ¼kle
                            </button>
                            <button class="btn-small btn-delete" onclick="deleteFile('${file.id}')">
                                ğŸ—‘ï¸ Sil
                            </button>
                        </div>
                    </div>
                `;
            });
            
            filesList.innerHTML = html;
        }
        
        function loadFile(fileId) {
            // LocalStorage'dan dosyayÄ± al
            let files = [];
            try {
                const savedFiles = localStorage.getItem('hasar_dosyalar');
                if (savedFiles) {
                    files = JSON.parse(savedFiles);
                }
            } catch (e) {
                console.error('Dosyalar yÃ¼klenemedi:', e);
                return;
            }
            
            const file = files.find(f => f.id === fileId);
            if (!file) {
                alert('âŒ Dosya bulunamadÄ±!');
                return;
            }
            
            // Onay al
            if (!confirm(`${file.sahipAd} - ${file.plaka}\n\nBu dosyayÄ± yÃ¼klemek istediÄŸinize emin misiniz?\nMevcut veriler silinecek!`)) {
                return;
            }
            
            // Form alanlarÄ±nÄ± doldur
            const fd = file.formData;
            document.getElementById('plaka').value = fd.plaka || '';
            document.getElementById('marka').value = fd.marka || '';
            document.getElementById('sasi').value = fd.sasi || '';
            document.getElementById('kilometre').value = fd.kilometre || '';
            document.getElementById('sahip_ad').value = fd.sahip_ad || '';
            document.getElementById('sahip_tel').value = fd.sahip_tel || '';
            document.getElementById('iban').value = fd.iban || '';
            
            document.getElementById('sigorta').value = fd.sigorta || '';
            document.getElementById('dosya_no').value = fd.dosya_no || '';
            document.getElementById('dosya_turu').value = fd.dosya_turu || 'KASKO';
            document.getElementById('police_no').value = fd.police_no || '';
            
            document.getElementById('eksper_adi').value = fd.eksper_adi || '';
            document.getElementById('eksper_iletisim').value = fd.eksper_iletisim || '';
            document.getElementById('servis_adi').value = fd.servis_adi || '';
            document.getElementById('servis_yetkili').value = fd.servis_yetkili || '';
            document.getElementById('servis_tel').value = fd.servis_tel || '';
            
            document.getElementById('kaza_tarihi').value = fd.kaza_tarihi || '';
            document.getElementById('kaza_yeri').value = fd.kaza_yeri || '';
            document.getElementById('kaza_aciklama').value = fd.kaza_aciklama || '';
            
            document.getElementById('notlar').value = fd.notlar || '';
            
            // ParÃ§a listesini yÃ¼kle
            partsList = file.parcaListesi || [];
            savePartsToStorage();
            renderPartsTable();
            
            // Modal'Ä± kapat
            closeSearchModal();
            
            // Ä°lk sekmeye geÃ§
            switchTab('dosya');
            
            alert(`âœ… Dosya yÃ¼klendi!\n\n${file.sahipAd} - ${file.plaka}\n${file.parcaListesi.length} parÃ§a yÃ¼klendi.`);
        }
        
        function deleteFile(fileId) {
            // LocalStorage'dan dosyalarÄ± al
            let files = [];
            try {
                const savedFiles = localStorage.getItem('hasar_dosyalar');
                if (savedFiles) {
                    files = JSON.parse(savedFiles);
                }
            } catch (e) {
                console.error('Dosyalar yÃ¼klenemedi:', e);
                return;
            }
            
            const file = files.find(f => f.id === fileId);
            if (!file) {
                alert('âŒ Dosya bulunamadÄ±!');
                return;
            }
            
            // Onay al
            if (!confirm(`${file.sahipAd} - ${file.plaka}\n\nBu dosyayÄ± silmek istediÄŸinize emin misiniz?`)) {
                return;
            }
            
            // DosyayÄ± sil
            files = files.filter(f => f.id !== fileId);
            
            try {
                localStorage.setItem('hasar_dosyalar', JSON.stringify(files));
                alert('âœ… Dosya silindi!');
                renderFilesList();
            } catch (e) {
                alert('âŒ Dosya silinemedi!');
                console.error('Silme hatasÄ±:', e);
            }
        }
        
        // Modal dÄ±ÅŸÄ±na tÄ±klanÄ±nca kapat
        window.onclick = function(event) {
            const modal = document.getElementById('searchModal');
            const previewModal = document.getElementById('previewModal');
            if (event.target === modal) {
                closeSearchModal();
            }
            if (event.target === previewModal) {
                closePreviewModal();
            }
        }
        
        // Ã–NÄ°ZLEME MODAL FONKSÄ°YONLARI
        let tempParcaListesi = [];
        
        function closePreviewModal() {
            document.getElementById('previewModal').style.display = 'none';
            tempParcaListesi = [];
        }
        
        function confirmParcaListesi() {
            if (tempParcaListesi.length === 0) {
                alert('âš ï¸ Eklenecek parÃ§a yok!');
                return;
            }
            
            // ParÃ§alarÄ± ekle
            partsList.push(...tempParcaListesi);
            savePartsToStorage();
            renderPartsTable();
            
            closePreviewModal();
            switchTab('parca');
            
            alert(`âœ… ${tempParcaListesi.length} parÃ§a baÅŸarÄ±yla eklendi!`);
        }
        
        // RUHSAT YÃœKLEME
        async function handleRuhsatUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Dosya boyutu kontrolÃ¼ (5MB)
            if (file.size > 5 * 1024 * 1024) {
                alert('âŒ Dosya Ã§ok bÃ¼yÃ¼k! Maksimum 5MB olmalÄ±.');
                return;
            }
            
            // Loading gÃ¶ster
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'aiLoading';
            loadingDiv.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 9999; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; padding: 30px; border-radius: 12px; text-align: center;">
                        <div style="font-size: 48px; margin-bottom: 15px;">ğŸ“¸</div>
                        <div style="font-size: 18px; font-weight: 600; color: #2C5F8D; margin-bottom: 10px;">Ruhsat Okunuyor</div>
                        <div style="font-size: 14px; color: #666;" id="ocrProgress">HazÄ±rlanÄ±yor...</div>
                        <div style="margin-top: 15px;">
                            <div style="width: 200px; height: 4px; background: #e0e0e0; border-radius: 2px; overflow: hidden;">
                                <div style="width: 100%; height: 100%; background: linear-gradient(90deg, #667eea, #764ba2); animation: loading 1.5s infinite;"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <style>
                    @keyframes loading {
                        0% { transform: translateX(-100%); }
                        100% { transform: translateX(100%); }
                    }
                </style>
            `;
            document.body.appendChild(loadingDiv);
            
            try {
                // Tesseract.js ile OCR
                const progressEl = document.getElementById('ocrProgress');
                
                const worker = await Tesseract.createWorker('tur', 1, {
                    logger: m => {
                        if (m.status === 'recognizing text') {
                            progressEl.textContent = `Okunuyor... %${Math.round(m.progress * 100)}`;
                        }
                    }
                });
                
                const { data: { text } } = await worker.recognize(file);
                await worker.terminate();
                
                // Ruhsat bilgilerini Ã§Ä±kar
                const ruhsatData = extractRuhsatInfo(text);
                
                // Formu doldur
                if (ruhsatData.marka) document.getElementById('marka').value = ruhsatData.marka;
                if (ruhsatData.plaka) document.getElementById('plaka').value = ruhsatData.plaka;
                if (ruhsatData.sasi) document.getElementById('sasi').value = ruhsatData.sasi;
                
                // Loading kaldÄ±r
                document.body.removeChild(loadingDiv);
                
                // BaÅŸarÄ± mesajÄ±
                if (ruhsatData.marka || ruhsatData.plaka || ruhsatData.sasi) {
                    alert(`âœ… Ruhsat okundu!\n\nğŸ“‹ Marka: ${ruhsatData.marka || '-'}\nğŸš— Plaka: ${ruhsatData.plaka || '-'}\nğŸ”¢ Åasi: ${ruhsatData.sasi || '-'}\n\nâš ï¸ LÃ¼tfen bilgileri kontrol edin!`);
                    switchTab('dosya');
                } else {
                    alert('âš ï¸ Ruhsat bilgileri okunamadÄ±!\n\nLÃ¼tfen manuel olarak girin veya daha net bir fotoÄŸraf deneyin.');
                }
                
            } catch (error) {
                console.error('OCR hatasÄ±:', error);
                document.body.removeChild(loadingDiv);
                alert('âŒ Ruhsat okunamadÄ±!\n\nLÃ¼tfen net bir fotoÄŸraf yÃ¼kleyin veya manuel olarak girin.');
            }
            
            // Input'u temizle
            event.target.value = '';
        }
        
        function extractRuhsatInfo(text) {
            const info = {
                marka: '',
                plaka: '',
                sasi: ''
            };
            
            // Plaka ara (TÃ¼rkiye formatÄ±: 34 ABC 123)
            const plakaRegex = /\b\d{2}\s*[A-Z]{1,3}\s*\d{2,4}\b/g;
            const plakaMatch = text.match(plakaRegex);
            if (plakaMatch && plakaMatch.length > 0) {
                info.plaka = plakaMatch[0].replace(/\s+/g, ' ').trim();
            }
            
            // Åasi ara (17 karakterli alfanumerik)
            const sasiRegex = /\b[A-HJ-NPR-Z0-9]{17}\b/g;
            const sasiMatch = text.match(sasiRegex);
            if (sasiMatch && sasiMatch.length > 0) {
                info.sasi = sasiMatch[0];
            }
            
            // Marka ara (yaygÄ±n markalar)
            const markalar = ['HONDA', 'YAMAHA', 'KAWASAKI', 'SUZUKI', 'BMW', 'KTM', 'DUCATI', 
                            'HARLEY', 'TRIUMPH', 'APRILIA', 'MV AGUSTA', 'BENELLI', 'KYMCO',
                            'TOYOTA', 'MERCEDES', 'BMW', 'AUDI', 'VOLKSWAGEN', 'RENAULT', 'FIAT',
                            'FORD', 'OPEL', 'PEUGEOT', 'CITROEN', 'HYUNDAI', 'KIA', 'NISSAN', 'MAZDA'];
            
            const upperText = text.toUpperCase();
            for (const marka of markalar) {
                if (upperText.includes(marka)) {
                    // Model de varsa birlikte al
                    const markaIndex = upperText.indexOf(marka);
                    const modelText = text.substring(markaIndex, markaIndex + 50);
                    const modelMatch = modelText.match(/[A-Z][A-Z0-9\s\-]{2,20}/);
                    if (modelMatch) {
                        info.marka = modelMatch[0].trim();
                    } else {
                        info.marka = marka;
                    }
                    break;
                }
            }
            
            return info;
        }
        
        function extractParcaListesi(text) {
            const parcalar = [];
            const lines = text.split('\n');
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line || line.length < 3) continue;
                
                // Fiyat ara (sayÄ± + TL, â‚º veya virgÃ¼l/nokta formatlarÄ±)
                const fiyatRegex = /(\d{1,3}(?:[.,]\d{3})*(?:[.,]\d{2})?)\s*(?:TL|â‚º|tl)?/g;
                const fiyatMatches = line.match(fiyatRegex);
                
                let fiyat = 0;
                if (fiyatMatches && fiyatMatches.length > 0) {
                    // En bÃ¼yÃ¼k sayÄ±yÄ± fiyat olarak al
                    const fiyatlar = fiyatMatches.map(f => {
                        const numStr = f.replace(/[TLâ‚ºtl\s]/g, '').replace(/\./g, '').replace(',', '.');
                        return parseFloat(numStr) || 0;
                    });
                    fiyat = Math.max(...fiyatlar);
                }
                
                // FiyatÄ± satÄ±rdan Ã§Ä±kar, kalan kÄ±smÄ± parÃ§a adÄ± olarak al
                let parcaAdi = line.replace(fiyatRegex, '').trim();
                
                // BaÅŸÄ±ndaki numaralarÄ± temizle (1. 2. gibi)
                parcaAdi = parcaAdi.replace(/^\d+[\.\)]\s*/, '');
                
                // Ã‡ok kÄ±sa veya fiyatsÄ±z satÄ±rlarÄ± atla
                if (parcaAdi.length >= 3 && (fiyat > 0 || parcaAdi.length > 10)) {
                    parcalar.push({
                        name: parcaAdi,
                        oem: '', // OCR'dan OEM Ã§Ä±karmak zor
                        original: fiyat,
                        quantity: 1
                    });
                }
            }
            
            // En az 1 parÃ§a bulunmalÄ±
            if (parcalar.length === 0) {
                // Alternatif: TÃ¼m metni tek parÃ§a olarak al
                const fiyatRegex = /(\d{1,3}(?:[.,]\d{3})*(?:[.,]\d{2})?)\s*(?:TL|â‚º|tl)?/g;
                const allFiyatlar = text.match(fiyatRegex);
                if (allFiyatlar && allFiyatlar.length > 0) {
                    const maxFiyat = Math.max(...allFiyatlar.map(f => {
                        const num = f.replace(/[TLâ‚ºtl\s]/g, '').replace(/\./g, '').replace(',', '.');
                        return parseFloat(num) || 0;
                    }));
                    
                    parcalar.push({
                        name: text.substring(0, 50).replace(/\n/g, ' ').trim() + '...',
                        oem: '',
                        original: maxFiyat,
                        quantity: 1
                    });
                }
            }
            
            return parcalar;
        }
        
        // PARÃ‡A LÄ°STESÄ° YÃœKLEME
        async function handleParcaListesiUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Dosya boyutu kontrolÃ¼ (5MB)
            if (file.size > 5 * 1024 * 1024) {
                alert('âŒ Dosya Ã§ok bÃ¼yÃ¼k! Maksimum 5MB olmalÄ±.');
                return;
            }
            
            // Loading gÃ¶ster
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'aiLoading';
            loadingDiv.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 9999; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; padding: 30px; border-radius: 12px; text-align: center;">
                        <div style="font-size: 48px; margin-bottom: 15px;">ğŸ“¸</div>
                        <div style="font-size: 18px; font-weight: 600; color: #2C5F8D; margin-bottom: 10px;">ParÃ§a Listesi Okunuyor</div>
                        <div style="font-size: 14px; color: #666;" id="ocrProgressParca">HazÄ±rlanÄ±yor...</div>
                        <div style="margin-top: 15px;">
                            <div style="width: 200px; height: 4px; background: #e0e0e0; border-radius: 2px; overflow: hidden;">
                                <div style="width: 100%; height: 100%; background: linear-gradient(90deg, #667eea, #764ba2); animation: loading 1.5s infinite;"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <style>
                    @keyframes loading {
                        0% { transform: translateX(-100%); }
                        100% { transform: translateX(100%); }
                    }
                </style>
            `;
            document.body.appendChild(loadingDiv);
            
            try {
                // Tesseract.js ile OCR
                const progressEl = document.getElementById('ocrProgressParca');
                
                const worker = await Tesseract.createWorker('tur', 1, {
                    logger: m => {
                        if (m.status === 'recognizing text') {
                            progressEl.textContent = `Okunuyor... %${Math.round(m.progress * 100)}`;
                        }
                    }
                });
                
                const { data: { text } } = await worker.recognize(file);
                await worker.terminate();
                
                // ParÃ§a bilgilerini Ã§Ä±kar
                const parcalar = extractParcaListesi(text);
                
                if (parcalar && parcalar.length > 0) {
                    tempParcaListesi = parcalar;
                    
                    // Loading kaldÄ±r
                    document.body.removeChild(loadingDiv);
                    
                    // Ã–nizleme gÃ¶ster
                    showPreview(tempParcaListesi);
                } else {
                    throw new Error('ParÃ§a bulunamadÄ±');
                }
                
            } catch (error) {
                console.error('ParÃ§a listesi okuma hatasÄ±:', error);
                document.body.removeChild(loadingDiv);
                alert('âŒ ParÃ§a listesi okunamadÄ±! LÃ¼tfen net bir fotoÄŸraf yÃ¼kleyin veya manuel olarak ekleyin.\n\nğŸ’¡ Ä°PUCU: YazÄ±lÄ± parÃ§a listelerinde daha iyi sonuÃ§ alÄ±rsÄ±nÄ±z. El yazÄ±sÄ± zor okunabilir.');
            }
            
            // Input'u temizle
            event.target.value = '';
        }
        
        function showPreview(parcalar) {
            const previewContent = document.getElementById('previewContent');
            
            let html = `
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: #f8f9fa;">
                            <th style="padding: 10px; border: 1px solid #dee2e6; text-align: left;">SÄ±ra</th>
                            <th style="padding: 10px; border: 1px solid #dee2e6; text-align: left;">ParÃ§a AdÄ±</th>
                            <th style="padding: 10px; border: 1px solid #dee2e6; text-align: left;">OEM Kod</th>
                            <th style="padding: 10px; border: 1px solid #dee2e6; text-align: right;">Orijinal (TL)</th>
                            <th style="padding: 10px; border: 1px solid #dee2e6; text-align: center;">Miktar</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            parcalar.forEach((part, index) => {
                html += `
                    <tr>
                        <td style="padding: 10px; border: 1px solid #dee2e6; text-align: center;">${index + 1}</td>
                        <td style="padding: 10px; border: 1px solid #dee2e6;">${part.name}</td>
                        <td style="padding: 10px; border: 1px solid #dee2e6;">${part.oem || '-'}</td>
                        <td style="padding: 10px; border: 1px solid #dee2e6; text-align: right; font-weight: 600;">${parseFloat(part.original).toLocaleString('tr-TR', {minimumFractionDigits: 2})}</td>
                        <td style="padding: 10px; border: 1px solid #dee2e6; text-align: center;">${part.quantity}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            
            previewContent.innerHTML = html;
            
            // Modal'Ä± gÃ¶ster
            document.getElementById('previewModal').style.display = 'block';
            
            // MesajÄ± gÃ¼ncelle
            document.getElementById('previewMessage').innerHTML = `
                <strong>âœ… AI Analizi TamamlandÄ±!</strong>
                <p style="margin: 5px 0 0 0; font-size: 13px;">${parcalar.length} parÃ§a tespit edildi. Kontrol edip onaylayÄ±n.</p>
            `;
        }
        
        // DosyayÄ± base64'e Ã§evirme fonksiyonu
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const base64 = reader.result.split(',')[1];
                    resolve(base64);
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }
        
        function createCompleteExcel() {
            const wb = XLSX.utils.book_new();
            
            // Ä°HBAR FÃ–YÃœ SAYFASI - DÃ¼zgÃ¼n tablo formatÄ±
            const ws1_data = [
                ['MOTOSÄ°KLET HASAR Ä°HBAR FÃ–YÃœ'],
                ['MR Hasar DanÄ±ÅŸmanlÄ±k ve Filo YÃ¶netimi'],
                [],
                ['ARAÃ‡ VE SAHÄ°P BÄ°LGÄ°LERÄ°'],
                ['Plaka:', getValue('plaka'), 'Marka/Model:', getValue('marka')],
                ['Åasi No:', getValue('sasi'), 'Kilometre:', getValue('kilometre')],
                ['Ruhsat Sahibi:', getValue('sahip_ad'), 'TC/Telefon:', getValue('sahip_tel')],
                ['IBAN:', getValue('iban'), '', ''],
                [],
                ['DOSYA BÄ°LGÄ°LERÄ°'],
                ['Sigorta Åirketi:', getValue('sigorta'), 'Dosya No:', getValue('dosya_no')],
                ['Dosya TÃ¼rÃ¼:', getValue('dosya_turu'), 'PoliÃ§e No:', getValue('police_no')],
                [],
                ['EKSPER VE SERVÄ°S BÄ°LGÄ°LERÄ°'],
                ['Eksper Ofisi & AdÄ±:', getValue('eksper_adi'), 'Ä°letiÅŸim:', getValue('eksper_iletisim')],
                ['â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€'],
                ['Servis AdÄ±:', getValue('servis_adi'), 'Yetkili:', getValue('servis_yetkili')],
                ['Servis Ä°letiÅŸim ve Adres:', getValue('servis_tel'), '', ''],
                [],
                ['KAZA BÄ°LGÄ°LERÄ°'],
                ['Kaza Tarihi:', getValue('kaza_tarihi')],
                ['Kaza Yeri:', getValue('kaza_yeri')],
                ['Kaza AÃ§Ä±klamasÄ±:', getValue('kaza_aciklama')],
                [],
                ['EVRAK KONTROL'],
                [getCheckedItems('evrak')],
                [],
                ['Ä°ÅLEM DURUMU'],
                [getCheckedItems('islem')],
                [],
                ['NOTLAR'],
                [getValue('notlar') || 'Yok']
            ];
            
            const ws1 = XLSX.utils.aoa_to_sheet(ws1_data);
            
            // Kolon geniÅŸlikleri
            ws1['!cols'] = [
                {wch: 25},
                {wch: 30},
                {wch: 20},
                {wch: 30}
            ];
            
            XLSX.utils.book_append_sheet(wb, ws1, 'Ä°hbar FÃ¶yÃ¼');
            
            // PARÃ‡A LÄ°STESÄ° SAYFASI
            if (partsList.length > 0) {
                const ws2_data = [
                    ['HASAR PARÃ‡A LÄ°STESÄ° VE FÄ°YATLANDIRMA'],
                    [`AraÃ§: ${getValue('marka')} - Plaka: ${getValue('plaka')}`],
                    [],
                    ['SÄ±ra', 'ParÃ§a AdÄ±', 'OEM Kodu', 'Orijinal (TL)', 'Muadil (TL)', 'Miktar']
                ];
                
                let totalOriginal = 0;
                let totalMuadil = 0;
                
                partsList.forEach((part, index) => {
                    const muadilValue = part.muadil === '-' ? 0 : parseFloat(part.muadil) || 0;
                    totalOriginal += part.original * part.quantity;
                    totalMuadil += muadilValue * part.quantity;
                    
                    ws2_data.push([
                        index + 1,
                        part.name,
                        part.oem || '-',
                        part.original,
                        part.muadil === '-' ? '-' : parseFloat(part.muadil),
                        part.quantity
                    ]);
                });
                
                ws2_data.push([]);
                ws2_data.push(['TOPLAM ORÄ°JÄ°NAL:', '', '', totalOriginal, '', '']);
                ws2_data.push(['TOPLAM MUADÄ°L:', '', '', totalMuadil, '', '']);
                const totalKarma = (totalOriginal + totalMuadil) / 2;
                ws2_data.push(['TAHMÄ°NÄ° HASAR (Karma):', '', '', totalKarma, '', '']);
                ws2_data.push([]);
                ws2_data.push(['NOT:', 'Orijinal parÃ§a fiyatlarÄ± yetkili servis gÃ¼ncel fiyatlarÄ±dÄ±r.']);
                ws2_data.push(['', 'Muadil parÃ§a fiyatlarÄ± A sÄ±nÄ±fÄ± kaliteli muadil parÃ§alara gÃ¶redir.']);
                ws2_data.push(['', 'Ä°ÅŸÃ§ilik bedeli, boya ve diÄŸer masraflar dahil deÄŸildir.']);
                
                const ws2 = XLSX.utils.aoa_to_sheet(ws2_data);
                
                // Kolon geniÅŸlikleri
                ws2['!cols'] = [
                    {wch: 8},
                    {wch: 35},
                    {wch: 20},
                    {wch: 15},
                    {wch: 15},
                    {wch: 8}
                ];
                
                XLSX.utils.book_append_sheet(wb, ws2, 'ParÃ§a Listesi');
            }
            
            // Excel dosyasÄ±nÄ± indir
            const plaka = getValue('plaka').replace(/\s+/g, '_') || 'dosya';
            const tarih = new Date().toISOString().split('T')[0].replace(/-/g, '');
            XLSX.writeFile(wb, `Komple_Ihbar_${plaka}_${tarih}.xlsx`);
            
            alert('âœ… Komple Excel dosyasÄ± (Ä°hbar FÃ¶yÃ¼ + ParÃ§a Listesi) indirildi!');
        }
        
        function createPartsOnlyExcel() {
            if (partsList.length === 0) {
                alert('âš ï¸ ParÃ§a listesi boÅŸ! LÃ¼tfen Ã¶nce parÃ§a ekleyin.');
                return;
            }
            
            const wb = XLSX.utils.book_new();
            
            const ws_data = [
                ['HASAR PARÃ‡A LÄ°STESÄ° VE FÄ°YATLANDIRMA'],
                [`AraÃ§: ${getValue('marka')} - Plaka: ${getValue('plaka')}`],
                [],
                ['SÄ±ra', 'ParÃ§a AdÄ±', 'OEM Kodu', 'Orijinal (TL)', 'Muadil (TL)', 'Miktar']
            ];
            
            let totalOriginal = 0;
            let totalMuadil = 0;
            
            partsList.forEach((part, index) => {
                const muadilValue = part.muadil === '-' ? 0 : parseFloat(part.muadil) || 0;
                totalOriginal += part.original * part.quantity;
                totalMuadil += muadilValue * part.quantity;
                
                ws_data.push([
                    index + 1,
                    part.name,
                    part.oem || '-',
                    part.original,
                    part.muadil === '-' ? '-' : parseFloat(part.muadil),
                    part.quantity
                ]);
            });
            
            ws_data.push([]);
            ws_data.push(['TOPLAM ORÄ°JÄ°NAL:', '', '', totalOriginal, '', '']);
            ws_data.push(['TOPLAM MUADÄ°L:', '', '', totalMuadil, '', '']);
            const totalKarma = (totalOriginal + totalMuadil) / 2;
            ws_data.push(['TAHMÄ°NÄ° HASAR (Karma):', '', '', totalKarma, '', '']);
            ws_data.push([]);
            ws_data.push(['NOT:', 'Orijinal parÃ§a fiyatlarÄ± yetkili servis gÃ¼ncel fiyatlarÄ±dÄ±r.']);
            ws_data.push(['', 'Muadil parÃ§a fiyatlarÄ± A sÄ±nÄ±fÄ± kaliteli muadil parÃ§alara gÃ¶redir.']);
            ws_data.push(['', 'Ä°ÅŸÃ§ilik bedeli, boya ve diÄŸer masraflar dahil deÄŸildir.']);
            
            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            
            // Kolon geniÅŸlikleri
            ws['!cols'] = [
                {wch: 8},
                {wch: 35},
                {wch: 20},
                {wch: 15},
                {wch: 15},
                {wch: 8}
            ];
            
            XLSX.utils.book_append_sheet(wb, ws, 'ParÃ§a Listesi');
            
            const plaka = getValue('plaka').replace(/\s+/g, '_') || 'dosya';
            const tarih = new Date().toISOString().split('T')[0].replace(/-/g, '');
            XLSX.writeFile(wb, `Parca_Listesi_${plaka}_${tarih}.xlsx`);
            
            alert('âœ… ParÃ§a listesi Excel dosyasÄ± indirildi!');
        }
        
        
        function getCheckedItems(prefix) {
            const items = [];
            document.querySelectorAll(`input[id^="${prefix}_"]`).forEach(cb => {
                if (cb.checked) {
                    items.push(cb.nextElementSibling.textContent);
                }
            });
            return items.join(', ') || 'Yok';
        }
        
    </script>
</body>
</html>
